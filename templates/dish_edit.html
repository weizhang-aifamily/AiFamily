<!doctype html>
<title>菜品编辑</title>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; margin: 0; padding: 2rem; }
    h1 { text-align: center; margin-bottom: 2rem; }
    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax: 360px, 1fr); gap: 1.5rem; }
    .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.08); padding: 1rem 1.5rem; }
    .card h2 { margin: 0 0 .5rem; font-size: 1.25rem; }
    .meta { color: #666; font-size: .9rem; margin-bottom: 1rem; }
    .form-group { margin-bottom: .75rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: .25rem; }
    select[multiple] { width: 100%; padding: .25rem .5rem; border: 1px solid #ccc; border-radius: 4px; font-size: .9rem; }
  </style>
<h2>菜品：{{ rows[0].name if rows else '' }}</h2>
<form method="post" action="{{ url_for('dish.dish_save', dish_id=request.view_args['dish_id']) }}">
<div class="cards">
        {% for r in rows %}
          {# 当前菜品已有标签 code 集合 #}
          {% set own_codes = r.tags | map(attribute='code') | list %}

          <div class="card">
            <h2>{{ r.name }}</h2>
            <div class="meta">
              评分：{{ r.rating }} | 耗时：{{ r.dish_cook_time }} 分钟
            </div>

            {# 按 group_code 分组渲染下拉框 #}
            {% set g_map = {} %}
            {% for t in tags %}
              {% set g = t.group_code %}
              {% if g not in g_map %}{% set _ = g_map.update({g: []}) %}{% endif %}
              {% set _ = g_map[g].append(t) %}
            {% endfor %}

            {% for g_code, g_tags in g_map.items() %}
              <div class="form-group">
                <label>{{ g_tags[0].group_name }}</label>
                <select multiple name="tags_{{ r.dish_id }}_{{ g_code }}[]">
                  {% for t in g_tags %}
                    <option value="{{ t.id }}" {% if t.code in own_codes %}selected{% endif %}>
                      {{ t.tag_name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            {% endfor %}
          </div>
        {% endfor %}
      </div>

      <div style="text-align: center; margin-top: 2rem;">
        <button type="submit">保存全部</button>
      </div>
</form>
<a href="{{ url_for('dish.dish_list') }}">返回列表</a>