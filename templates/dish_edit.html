<!doctype html>
<title>菜品编辑</title>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; margin: 0; padding: 2rem; }
    h1 { text-align: center; margin-bottom: 2rem; }
    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax: 360px, 1fr); gap: 1.5rem; }
    .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.08); padding: 1rem 1.5rem; }
    .card h2 { margin: 0 0 .5rem; font-size: 1.25rem; }
    .meta { color: #666; font-size: .9rem; margin-bottom: 1rem; }
    .form-group { margin-bottom: .75rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: .25rem; }
    select[multiple] { width: 100%; padding: .25rem .5rem; border: 1px solid #ccc; border-radius: 4px; font-size: .9rem; }
  </style>
<h2>菜品：{{ rows[0].name if rows else '' }}</h2>
<form method="post" action="{{ url_for('dish.dish_save', dish_id=request.view_args['dish_id']) }}">

 <div class="cards">
            <!-- 使用Jinja2模板语法直接渲染 -->
            {% for r in rows %}
            <div class="card">
                <h2>{{ r.name }}</h2>
                <div class="meta">
                    评分：{{ r.rating }} | 耗时：{{ r.dish_cook_time }} 分钟
                </div>

                {# 按组分类标签 #}
                {% set g_all = {} %}
                {% for t in tags %}
                    {% set g = t.group_code %}
                    {% if g not in g_all %}
                        {% set _ = g_all.update({g: {'name': t.group_name, 'tags': []}}) %}
                    {% endif %}
                    {% set _ = g_all[g]['tags'].append(t) %}
                {% endfor %}

                {# 当前菜品已有标签 #}
                {% set own_codes = r.tags | map(attribute='code') | list %}

                {# 渲染每个标签组 #}
                {% for g_code, g_data in g_all.items() %}
                <div class="form-group">
                    <label>{{ g_data.name }}</label>
                    <div class="tag-row" id="{{ g_code }}_{{ r.dish_id }}">
                        {# 渲染已选择的标签 #}
                        {% for tag in r.tags if tag.group == g_code %}
                        <select name="tags_{{ r.dish_id }}_{{ g_code }}[]">
                            <option value="">请选择</option>
                            {% for opt in g_data.tags %}
                            <option value="{{ opt.tag_code }}" {{ 'selected' if opt.tag_code == tag.code }}>
                                {{ opt.tag_name }}
                            </option>
                            {% endfor %}
                        </select>
                        {% endfor %}

                        {# 如果没有已选标签，添加一个空的选择框 #}
                        {% if not r.tags | selectattr('group', 'equalto', g_code) | list %}
                        <select name="tags_{{ r.dish_id }}_{{ g_code }}[]">
                            <option value="">请选择</option>
                            {% for opt in g_data.tags %}
                            <option value="{{ opt.tag_code }}">{{ opt.tag_name }}</option>
                            {% endfor %}
                        </select>
                        {% endif %}
                    </div>
                    <button class="add-btn" onclick="addTagOption('{{ g_code }}_{{ r.dish_id }}', 'tags_{{ r.dish_id }}_{{ g_code }}[]')">+ 添加更多</button>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>

      <div style="text-align: center; margin-top: 2rem;">
        <button type="submit">保存全部</button>
      </div>
</form>
<a href="{{ url_for('dish.dish_list') }}">返回列表</a>