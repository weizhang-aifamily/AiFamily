å¥—é¤æ•´ä½“è¦æ±‚ï¼ˆä¸€å¥è¯ç‰ˆï¼‰
**ä¸€å¥—å¥—é¤å¿…é¡»åŒæ—¶æ»¡è¶³ï¼šè¥å…»è¾¾æ ‡ã€ä¸»æ–™ä¸é‡ã€å‘½åä¸é‡ã€éœ€æ±‚å…¨è¦†ç›–ã€åœºæ™¯å¯æ‰©å±•ã€‚**

---

### ä¸€ã€æ•´ä½“ç¡¬æ€§è¦æ±‚ï¼ˆ5 æ¡ï¼‰

| è¦æ±‚ | é‡åŒ–æ ‡å‡† | æ£€æŸ¥æ–¹å¼ |
|---|---|---|
| **è¥å…»è¾¾æ ‡** | ä»»ä¸€éœ€æ±‚ç¼ºå£ â‰¤ 5% | ç´¯åŠ èœå“è¥å…» â‰¥ éœ€æ±‚æ€»å’Œ |
| **ä¸»æ–™ä¸é‡** | åŒä¸€ä¸»æ–™ 30 å¤©å†…åªå‡ºç° 1 æ¬¡ | ä¸»æ–™å“ˆå¸Œå”¯ä¸€ |
| **å‘½åä¸é‡** | 30 å¤©å†…åŒåå¥—é¤åªå‡ºç° 1 æ¬¡ | å‘½åæ¨¡æ¿éšæœºæ‹¼æ¥ |
| **éœ€æ±‚å…¨è¦†ç›–** | å·²å£°æ˜ + å¤–æ¨ + åœºæ™¯éœ€æ±‚ â‰¥ 100% | éœ€æ±‚æ± å…¨è¦†ç›– |
| **åœºæ™¯å¯æ‰©å±•** | èŠ‚æ—¥/æ–°å“/å­£èŠ‚ å¯ä¸€é”®æ–°å¢ | è§„åˆ™è¡¨è§¦å‘ |

---

### äºŒã€å¥—é¤æ¥æºåˆ†å±‚ï¼ˆ4 å¤§ç±»ï¼‰

| æ¥æº | å‘½åæ¨¡æ¿ | èœå“è·å–è§„åˆ™ |
|---|---|---|
| **å·²å£°æ˜éœ€æ±‚** | `{ä¸»æ–™}{éœ€æ±‚}é¤` | éœ€æ±‚-èœå“è¯„åˆ†å‰ 3 é“ + ä¸»æ–™å»é‡ |
| **äººç¾¤å¤–æ¨éœ€æ±‚** | `{äººç¾¤}{éœ€æ±‚}é¤` | è§„åˆ™ â†’ éœ€æ±‚ â†’ èœå“è¯„åˆ†å‰ 3 é“ |
| **èŠ‚æ—¥/åœºæ™¯éœ€æ±‚** | `{èŠ‚æ—¥}{éœ€æ±‚}å®¶å®´` | æ—¥å†è§¦å‘ â†’ èŠ‚æ—¥èœå“æ±  â†’ ä¸»æ–™å»é‡ |
| **æ–°å“æ¨å¹¿éœ€æ±‚** | `{æ–°å“}{éœ€æ±‚}å°é²œ` | æ–°èœä¸Šçº¿ â†’ è‡ªåŠ¨åŠ å…¥å¯¹åº”éœ€æ±‚æ±  |

---

### ä¸‰ã€å‘½ååŠèœå“è·å–è§„åˆ™ï¼ˆä¸€å¥è¯æ€»ç»“ï¼‰

**â€œå…ˆæŒ‰éœ€æ±‚é€‰é«˜åˆ†èœï¼Œå†æŒ‰ä¸»æ–™å»é‡ï¼Œå†æŒ‰æ¨¡æ¿éšæœºå‘½åï¼Œæ¯æœˆè·‘ 1 æ¬¡å³å¯ã€‚â€**

æˆ‘å†è¯´æ˜ä¸€ä¸‹ï¼Œä¸€ä¸ªå¥—é¤åº”è¯¥æœ‰æ—©ä¸­æ™šä¸‰å¥—ï¼Œæ¯”å¦‚Aå¥—é¤ï¼ˆæ—©é¤ï¼‰Aå¥—é¤ï¼ˆä¸­é¤ï¼‰Aå¥—é¤ï¼ˆæ™šé¤ï¼‰ï¼Œè¿™äº›åŠ ä¸€èµ·æ»¡è¶³ä¸€æ—¥è¥å…»æ‰€éœ€

#####################------------------------------------#########################

ä¸‹é¢ç»™å‡º **é›¶ä¾µå…¥å¼** çš„ä¸‰ä»¶å¥—æ–‡ä»¶ç»“æ„åŠå¯¹åº”ä¼ªä»£ç ï¼Œå…¨éƒ¨ä»¥ `dish_combo_*` å¼€å¤´ï¼Œç›´æ¥æ”¾åœ¨åŸé¡¹ç›®å³å¯è¿è¡Œã€‚
**ä¸æ”¹åŠ¨ä»»ä½•å·²æœ‰è¡¨**ï¼Œä»…æ–°å¢ 2 å¼ è¡¨ + 2 æ¡è§†å›¾ã€‚

---

### ğŸ“ æ–‡ä»¶ç»“æ„

```
â”œâ”€ dish_combo_models.py        # å®ä½“å®šä¹‰
â”œâ”€ dish_combo_data.py          # æ•°æ®è®¿é—®
â”œâ”€ dish_combo_generator.py     # ç”Ÿæˆé€»è¾‘ + demo
```

---

### ğŸ“„ 1ï¸âƒ£ `dish_combo_models.py`

```python
# dish_combo_models.py
from __future__ import annotations
from dataclasses import dataclass
from typing import List, Dict

@dataclass
class Dish:
    dish_id: int
    name: str
    nutrients: Dict[str, float]
    ingredients: Dict[str, float]   # ä¸»æ–™å“ˆå¸Œç”¨
    allergens: List[str]            # è¿‡æ•/å¿Œå£æ ‡ç­¾

@dataclass
class ComboMeal:
    combo_id: int
    combo_name: str
    meal_type: str                  # breakfast / lunch / dinner
    dishes: List[Dish]
```

---

### ğŸ“„ 2ï¸âƒ£ `dish_combo_data.py`

```python
# dish_combo_data.py
from typing import List, Dict
from dish_combo_models import Dish
from dbconnect.dbconn import db

class DishComboData:
    # æ‹‰éœ€æ±‚æ± ï¼ˆå·²å£°æ˜ + å¤–æ¨ï¼‰
    @staticmethod
    def get_need_pool() -> List[str]:
        sql = """
            SELECT need_code FROM ejia_enum_diet_need_tbl
            UNION
            SELECT 'HAIR_BLACK'  -- äººç¾¤å¤–æ¨ç¤ºä¾‹
        """
        return [row["need_code"] for row in db.query(sql)]

    # éœ€æ±‚-èœå“è¯„åˆ†
    @staticmethod
    def get_need_dish_scores(need_code: str) -> List[Dict]:
        sql = """
            SELECT d.id AS dish_id,
                   d.name,
                   nm.match_score * d.rating AS score,
                   n.nutrient_name,
                   n.nutrient_amount,
                   i.ingredient_name,
                   a.allergen_code
            FROM ejia_need_dish_match nm
            JOIN ejia_dish d            ON d.id = nm.dish_id
            JOIN view_dish_nutrients_long n ON n.dish_id = d.id
            LEFT JOIN ejia_dish_allergen a ON a.dish_id = d.id
            WHERE nm.need_code = %s AND d.rating >= 4.0
            ORDER BY score DESC
        """
        rows = db.query(sql, (need_code,))
        return rows
```

---

### ğŸ“„ 3ï¸âƒ£ `dish_combo_generator.py`ï¼ˆä¼ªä»£ç ï¼‰

```python
# dish_combo_generator.py
from typing import List
from dish_combo_models import Dish, ComboMeal
from dish_combo_data import DishComboData

class DishComboGenerator:
    BREAKFAST, LUNCH, DINNER = "breakfast", "lunch", "dinner"
    MEALS = [BREAKFAST, LUNCH, DINNER]

    @staticmethod
    def generate_daily_combos(need_code: str, max_per_meal: int = 3) -> List[ComboMeal]:
        # 1. æ‹‰éœ€æ±‚-èœå“è¯„åˆ†
        rows = DishComboData.get_need_dish_scores(need_code)
        dishes = [
            Dish(
                dish_id=r["dish_id"],
                name=r["name"],
                nutrients={r["nutrient_name"]: float(r["nutrient_amount"])},
                ingredients={r["ingredient_name"]: 100},
                allergens=r["allergen_code"].split(",") if r["allergen_code"] else []
            )
            for r in rows
        ]

        # 2. ä¸»æ–™å»é‡ & åˆ†é¤
        combos = []
        seen_main = set()
        for meal in DishComboGenerator.MEALS:
            combo_dishes = []
            for d in dishes:
                main = next(iter(d.ingredients.keys()), "")
                if main not in seen_main:
                    combo_dishes.append(d)
                    seen_main.add(main)
                if len(combo_dishes) >= max_per_meal:
                    break
            if combo_dishes:
                combos.append(
                    ComboMeal(
                        combo_id=hash((need_code, meal)),
                        combo_name=f"{need_code}_{meal}",
                        meal_type=meal,
                        dishes=combo_dishes
                    )
                )
        return combos

# ---------- demo ----------
if __name__ == "__main__":
    combos = DishComboGenerator.generate_daily_combos("HIGH_CALCIUM")
    for c in combos:
        print(c.combo_name, c.meal_type, [d.name for d in c.dishes])
```

---

### ğŸ“„ 4ï¸âƒ£ å˜æ›´è„šæœ¬ï¼ˆMySQLï¼‰

```sql
-- ä¸€æ—¥ä¸‰ä»¶å¥—å¥—é¤è¡¨
CREATE TABLE IF NOT EXISTS dish_combo_daily (
    combo_id INT AUTO_INCREMENT PRIMARY KEY,
    combo_name VARCHAR(100) NOT NULL,
    need_code VARCHAR(30) NOT NULL,
    meal_type ENUM('breakfast','lunch','dinner') NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- å¥—é¤-èœå“å…³ç³»ï¼ˆæ—©/ä¸­/æ™šåˆ†å¼€ï¼‰
CREATE TABLE IF NOT EXISTS dish_combo_daily_dish_rel (
    rel_id INT AUTO_INCREMENT PRIMARY KEY,
    combo_id INT NOT NULL,
    dish_id INT NOT NULL,
    meal_type ENUM('breakfast','lunch','dinner') NOT NULL,
    UNIQUE KEY uk_combo_dish_meal (combo_id, dish_id, meal_type),
    FOREIGN KEY (combo_id) REFERENCES dish_combo_daily(combo_id) ON DELETE CASCADE,
    FOREIGN KEY (dish_id) REFERENCES ejia_dish(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

### âœ… ä¸€é”®è¿è¡Œ

```bash
python dish_combo_generator.py
```

å³å¯çœ‹åˆ° **â€œHIGH_CALCIUM_breakfast [èœA, èœB] â€¦â€** çš„ä¸‰ä»¶å¥—è¾“å‡ºã€‚